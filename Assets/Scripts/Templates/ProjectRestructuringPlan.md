# Unityプロジェクト再構築計画

## 🎯 目標
巨大なManagerクラスを単一責務のコンポーネントに分割し、安定性と保守性を向上させる。

## 📊 現状分析

### 問題のある巨大クラス
1. **GameManager.cs** (363行)
   - ゲーム状態管理
   - プレイヤーデータ管理
   - 階層システム
   - デッキシステム
   - 戦闘管理
   - イベント管理

2. **UIManager.cs** (294行)
   - UI表示更新
   - イベント処理
   - ログ管理
   - シーン遷移処理

3. **CardManager.cs** (324行)
   - カードプール管理
   - 手札管理
   - UI生成
   - カード効果実行

## 🚀 再構築戦略

### STEP 1: 単一責務コンポーネントへの分割

#### 1.1 戦闘システムの分離 ✅
```
BattleStarter.cs (戦闘開始専用)
BattleStateSO.cs (戦闘状態管理専用)
BattleUnit.cs (ユニット状態管理専用)
BattleEventChannel.cs (戦闘イベント専用)
BattleConfigSO.cs (戦闘設定専用)
```

#### 1.2 セーブシステムの分離 ✅
```
SaveLoader.cs (セーブロード専用)
SaveEventChannel.cs (セーブイベント専用)
GameData.cs (ゲームデータ構造体)
```

#### 1.3 次に分離予定のシステム
```
PlayerDataManager.cs (プレイヤーデータ管理専用)
FloorSystemManager.cs (階層システム専用)
DeckSystemManager.cs (デッキシステム専用)
UISystemManager.cs (UIシステム専用)
```

### STEP 2: テンプレート化と機能分離

#### 2.1 戦闘システムテンプレート ✅
- 独立して動作可能
- ScriptableObjectで状態管理
- EventChannelで疎結合
- 単体テスト可能

#### 2.2 セーブシステムテンプレート ✅
- 自動セーブ機能
- JSON形式での保存
- エラーハンドリング
- セーブ情報表示

#### 2.3 次に作成予定のテンプレート
```
PlayerDataTemplate/
├── PlayerDataManager.cs
├── PlayerDataSO.cs
├── PlayerEventChannel.cs
└── PlayerDataTest.cs

FloorSystemTemplate/
├── FloorManager.cs
├── FloorDataSO.cs
├── FloorEventChannel.cs
└── FloorSystemTest.cs

DeckSystemTemplate/
├── DeckManager.cs
├── DeckDataSO.cs
├── DeckEventChannel.cs
└── DeckSystemTest.cs
```

### STEP 3: 段階的移行

#### 3.1 戦闘システム移行 ✅
1. **BattleStarter**をシーンに追加
2. **BattleStateSO**アセットを作成
3. **BattleConfigSO**アセットを作成
4. **BattleEventChannel**アセットを作成
5. 既存の戦闘機能を新システムに移行
6. 動作確認後、旧コードを削除

#### 3.2 セーブシステム移行 ✅
1. **SaveLoader**をシーンに追加
2. **SaveEventChannel**アセットを作成
3. 既存のセーブ機能を新システムに移行
4. 動作確認後、旧コードを削除

#### 3.3 GameManager統合 ✅
1. 戦闘システム統合機能を追加
2. イベント購読機能を実装
3. プレイヤーデータ同期機能を追加
4. 後方互換性を維持



#### 3.3 その他のシステム移行
同様の手順で各システムを段階的に移行

## 📋 移行チェックリスト

### 戦闘システム移行
- [ ] BattleStarterが正常に動作する
- [ ] BattleStateSOで戦闘状態が管理される
- [ ] BattleEventChannelでイベントが正しく発火する
- [ ] 既存の戦闘機能が新システムで動作する
- [ ] UIが新システムのイベントに反応する
- [ ] テストで動作確認が完了する
- [ ] 旧GameManagerの戦闘関連コードを削除

### セーブシステム移行
- [ ] SaveLoaderが正常に動作する
- [ ] 自動セーブが機能する
- [ ] セーブファイルが正しく作成される
- [ ] ロード機能が正常に動作する
- [ ] エラーハンドリングが機能する
- [ ] 旧GameManagerのセーブ関連コードを削除

### 全体的な移行
- [ ] 各テンプレートが独立して動作する
- [ ] コンポーネント間の依存関係が最小化される
- [ ] イベントチャンネルで疎結合が実現される
- [ ] 単体テストが容易になる
- [ ] 新機能の追加が容易になる
- [ ] コードの可読性が向上する

## 🧪 テスト戦略

### 単体テスト
各テンプレートに専用のテストスクリプトを作成
- BattleSystemTest.cs ✅
- SaveSystemTest.cs (作成予定)
- PlayerDataTest.cs (作成予定)

### 統合テスト
既存のシステムと新システムの連携テスト
- 戦闘→セーブ→ロードの一連の流れ
- UI更新の確認
- エラーハンドリングの確認

### パフォーマンステスト
- メモリ使用量の確認
- フレームレートの確認
- セーブロード時間の確認

## ⚠️ 注意事項

### 移行時の注意点
1. **段階的移行**: 一度に全てを移行せず、機能ごとに段階的に移行
2. **バックアップ**: 移行前に既存コードのバックアップを作成
3. **テスト**: 各段階で十分なテストを実施
4. **ロールバック**: 問題が発生した場合のロールバック手順を準備

### 開発時の注意点
1. **単一責務**: 各コンポーネントは1つの目的のみを担当
2. **疎結合**: コンポーネント間の依存関係を最小化
3. **イベント駆動**: 直接参照ではなくイベント経由で通信
4. **ScriptableObject活用**: 状態管理はSOで行う

## 📈 期待される効果

### 短期的効果
- コードの可読性向上
- バグの特定・修正が容易
- 新機能の追加が容易

### 長期的効果
- プロジェクトの保守性向上
- 再利用可能なコンポーネント
- チーム開発の効率化
- 拡張性の向上

## 🎯 次のステップ

### 即座に実行可能
1. 戦闘システムテンプレートの動作確認
2. セーブシステムテンプレートの作成完了
3. 既存プロジェクトへの段階的導入

### 中期的な計画
1. プレイヤーデータシステムの分離
2. 階層システムの分離
3. デッキシステムの分離
4. UIシステムの分離

### 長期的な計画
1. 全システムのテンプレート化完了
2. 再利用可能なアセットパッケージの作成
3. 他のプロジェクトでの活用

## 📞 サポート

移行中に問題が発生した場合は、以下の手順で対応：
1. ログの確認
2. 単体テストの実行
3. 段階的なロールバック
4. 必要に応じて既存システムとの併用

この計画に従って段階的に移行することで、プロジェクトの安定性と保守性を大幅に向上させることができます。 